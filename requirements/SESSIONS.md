# Session Management

> Comprehensive guide to how Claude Code sessions work, including file formats, API limitations, and iOS app implementation details.

## Overview

Sessions are persistent conversation threads between a user and Claude. Each session is stored as a JSONL file on the server and can be resumed across app launches.

## Server-Side Storage

### Location

Sessions are stored in the Claude CLI's project directory structure:

```
$HOME/.claude/projects/{encoded-path}/{session-id}.jsonl
```

> **Note**: Use `$HOME` instead of `~` in SSH commands. Tilde expansion doesn't work reliably inside quoted strings. See `.claude/rules/ssh-security.md` for details.

**Path Encoding**: Project paths are encoded by replacing `/` with `-`:
- `/home/dev/workspace/ClaudeCodeApp` → `-home-dev-workspace-ClaudeCodeApp`

**Session ID Format**: Standard UUID v4:
- `xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx`
- Example: `072cbcc6-99ae-4a67-9d50-ed3ab2d23e92`

### Session File Types

| Type | Pattern | Source | Count (typical) |
|------|---------|--------|-----------------|
| User Sessions | `{uuid}.jsonl` | iOS app, Claude CLI | 50-100+ |
| Agent Sessions | `agent-{id}.jsonl` | Claude CLI Task tool | 200+ |
| Helper Sessions | `{uuid}.jsonl` | ClaudeHelper queries | 1 per project |

**Agent Sessions**: Created by Claude CLI's Task tool when spawning sub-agents. These have `isSidechain: true` in their messages. The iOS app does not create these.

**Helper Sessions**: Used by ClaudeHelper for suggestions and file analysis. One deterministic session per project (created from hashed project path).

## JSONL Message Format

Each line in a session file is a JSON object. Common message types:

### User Message (Array Content)
```json
{
  "type": "user",
  "parentUuid": null,
  "isSidechain": false,
  "userType": "external",
  "cwd": "/home/dev/workspace/ClaudeCodeApp",
  "sessionId": "072cbcc6-99ae-4a67-9d50-ed3ab2d23e92",
  "version": "2.0.76",
  "gitBranch": "main",
  "message": {
    "role": "user",
    "content": [
      {"type": "text", "text": "What suggestions do you have?"}
    ]
  },
  "uuid": "52a0fd51-dfdb-4082-89d7-9c91bd353f9e",
  "timestamp": "2025-12-27T06:44:55.883Z"
}
```

### User Message (String Content)
```json
{
  "type": "user",
  "message": {
    "role": "user",
    "content": "Unknown slash command: model"
  },
  "uuid": "82962de4-6b1e-4ef4-9dde-73d099e9a4f8",
  "timestamp": "2025-12-27T06:17:30.331Z"
}
```

### Meta Message (System/Internal)
```json
{
  "type": "user",
  "isMeta": true,
  "message": {
    "role": "user",
    "content": "Caveat: The messages below were generated by the user while running local commands..."
  }
}
```

### Assistant Message
```json
{
  "type": "assistant",
  "parentUuid": "52a0fd51-dfdb-4082-89d7-9c91bd353f9e",
  "message": {
    "model": "claude-opus-4-5-20251101",
    "id": "msg_01Ez2cg2BaKqBuFbwuJak3HG",
    "type": "message",
    "role": "assistant",
    "content": [{"type": "text", "text": "Based on my review..."}],
    "stop_reason": null,
    "usage": {"input_tokens": 3, "output_tokens": 1}
  },
  "uuid": "305cd830-7e3e-45ef-acd9-be48bd2681ef",
  "timestamp": "2025-12-27T06:45:11.812Z"
}
```

### Queue Operation (Internal)
```json
{
  "type": "queue-operation",
  "operation": "dequeue",
  "timestamp": "2025-12-27T06:44:55.863Z",
  "sessionId": "072cbcc6-99ae-4a67-9d50-ed3ab2d23e92"
}
```

## API Limitations

### Backend API (claudecodeui)

The backend API at `/api/projects` returns projects with sessions, but has limitations:

```json
{
  "projects": [{
    "path": "/home/dev/workspace/ClaudeCodeApp",
    "title": "ClaudeCodeApp",
    "sessions": [
      {"id": "xxx", "messageCount": 3, "lastActivity": "..."},
      // ... LIMITED to ~5 most recent sessions
    ]
  }]
}
```

**Key Limitation**: The API only returns approximately 5 most recent sessions per project, even when there are 80+ sessions on the server.

### Workaround: SSH-Based Loading

The iOS app bypasses this limitation by loading sessions directly via SSH:

```swift
// SSHManager.loadAllSessions() - loads ALL sessions with metadata
// SSHManager.countSessionsForProjects() - efficiently counts sessions
```

## iOS App Session Management

### Session ID Sources

| Source | Where Used | Notes |
|--------|-----------|-------|
| `wsManager.sessionId` | Active WebSocket session | Set on `session-created` callback |
| `selectedSession?.id` | Selected from picker | From API or SSH-loaded sessions |
| `localSessions` | ChatView state | Merged API + SSH sessions |
| `sessionCounts` | ContentView state | SSH-loaded counts per project |

### Session Creation Flow

1. **User clicks "New"** → Clears `wsManager.sessionId` and `selectedSession`
2. **User sends first message** → Backend creates session → `session-created` WebSocket message
3. **`onSessionCreated` callback** → Sets `wsManager.sessionId`, saves to `MessageStore`
4. **Session appears in picker** → Added to `localSessions`, filter passes it through

### ClaudeHelper Sessions

ClaudeHelper (suggestions, file analysis) uses a deterministic session ID per project:

```swift
// ClaudeHelper.createHelperSessionId(for:)
// Generates consistent UUID from project path hash
// Example: /home/dev/workspace/ClaudeCodeApp → always same UUID
```

This prevents session pollution (previously created new session for every helper call).

### Session Filtering

Sessions are filtered for display to exclude:
- Helper sessions (matched by `ClaudeHelper.createHelperSessionId`)
- Empty sessions (`messageCount < 1`)
- Agent sessions (filtered at shell level by `grep -v '^agent-'`)

```swift
// Models.swift - filterForDisplay()
extension Array where Element == ProjectSession {
    func filterForDisplay(projectPath: String, activeSessionId: String? = nil) -> [ProjectSession]
}
```

### Session Persistence

| Store | Key | Purpose |
|-------|-----|---------|
| UserDefaults | `sessionId_{encoded-path}` | Last active session per project |
| MessageStore | `{encoded-path}.json` | Chat history (50 messages) |

## SSH Commands for Sessions

> **Note**: When running these commands from Swift via SSH, use `$HOME` instead of `~` and double quotes. See `.claude/rules/ssh-security.md`.

### Count Sessions
```bash
cd $HOME/.claude/projects/-home-dev-workspace-ClaudeCodeApp && \
ls -1 *.jsonl 2>/dev/null | grep -v '^agent-' | while read f; do
    [ -s "$f" ] && echo "$f"
done | wc -l
```

### List Sessions with Metadata
```bash
cd $HOME/.claude/projects/-home-dev-workspace-ClaudeCodeApp && \
ls -1 *.jsonl 2>/dev/null | grep -v '^agent-' | while read f; do
    name=$(basename "$f" .jsonl)
    lines=$(wc -l < "$f" | tr -d ' ')
    mtime=$(stat -c %Y "$f" 2>/dev/null || stat -f %m "$f" 2>/dev/null)
    echo "$name|$lines|$mtime"
done
```

### Extract First User Message (Summary)
```bash
# Uses jq to handle both content formats (array and string)
grep '"type":"user"' session.jsonl | \
jq -r 'select(.isMeta != true) |
    (if .message.content | type == "array" then .message.content[0].text
     elif .message.content | type == "string" then .message.content
     else empty end) // empty' | \
grep -v '^Based on this conversation' | \
head -1 | head -c 80
```

## Key Files

| File | Purpose |
|------|---------|
| `WebSocketManager.swift` | Session creation via `session-created` callback |
| `ChatView.swift` | Session selection, `loadAllSessionsViaSSH()` |
| `SSHManager.swift` | `loadAllSessions()`, `countSessionsForProjects()` |
| `Models.swift` | `ProjectSession`, `filterForDisplay()` |
| `SessionPickerViews.swift` | Session picker UI, SSH loading |
| `ContentView.swift` | Project list with session counts |
| `MessageStore.swift` | Session ID persistence |
| `ClaudeHelper.swift` | Helper session ID generation |

## Common Issues

### Sessions Not Appearing in Picker
1. Check if `wsManager.sessionId` is set in `onSessionCreated`
2. Verify filter isn't too aggressive (`messageCount >= 1`)
3. Ensure `activeSessionId` is passed through filter

### Wrong Session Counts
1. API returns limited sessions (~5) - use SSH loading
2. Verify `sessionCounts` dictionary is populated
3. Check `loadAllSessionCounts()` is called

### ClaudeHelper Creating Many Sessions
1. Ensure `createHelperSessionId()` returns valid UUID format
2. Verify helper session ID is consistent for same project path
3. Check filter excludes helper sessions from picker

### Session Titles Missing
1. Check `jq` is installed on server
2. Verify shell command handles both content formats
3. Ensure ClaudeHelper prompts are filtered (`grep -v`)

## Testing Sessions

```bash
# SSH to server
ssh claude-dev

# Navigate to project sessions (use $HOME when called from Swift)
cd $HOME/.claude/projects/-home-dev-workspace-ClaudeCodeApp

# Count all sessions
ls -1 *.jsonl | wc -l

# Count user sessions (exclude agents)
ls -1 *.jsonl | grep -v '^agent-' | wc -l

# View a session
cat {session-id}.jsonl | jq .

# Find user messages
grep '"type":"user"' {session-id}.jsonl | jq .message.content
```
