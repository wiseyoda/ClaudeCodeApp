# Session Management

> Comprehensive guide to how Claude Code sessions work, including file formats, API, and iOS app implementation details.

## Overview

Sessions are persistent conversation threads between a user and Claude. Each session is stored as a JSONL file on the server and can be resumed across app launches.

## Server-Side Storage

### Location

Sessions are stored in the Claude CLI's project directory structure:

```
$HOME/.claude/projects/{encoded-path}/{session-id}.jsonl
```

> **Note**: Use `$HOME` instead of `~` in SSH commands. Tilde expansion doesn't work reliably inside quoted strings. See `.claude/rules/ssh-security.md` for details.

**Path Encoding**: Project paths are encoded by replacing `/` with `-`:
- `/home/dev/workspace/ClaudeCodeApp` -> `-home-dev-workspace-ClaudeCodeApp`

**Session ID Format**: Standard UUID v4:
- `xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx`
- Example: `072cbcc6-99ae-4a67-9d50-ed3ab2d23e92`

### Session File Types

| Type | Pattern | Source | Count (typical) |
|------|---------|--------|-----------------|
| User Sessions | `{uuid}.jsonl` | iOS app, Claude CLI | 50-100+ |
| Agent Sessions | `agent-{id}.jsonl` | Claude CLI Task tool | 200+ |
| Helper Sessions | `{uuid}.jsonl` | ClaudeHelper queries | 1 per project |

**Agent Sessions**: Created by Claude CLI's Task tool when spawning sub-agents. These have `isSidechain: true` in their messages. The iOS app does not create these.

**Helper Sessions**: Used by ClaudeHelper for suggestions and file analysis. One deterministic session per project (created from hashed project path).

## JSONL Message Format

Each line in a session file is a JSON object. Common message types:

### User Message (Array Content)
```json
{
  "type": "user",
  "parentUuid": null,
  "isSidechain": false,
  "userType": "external",
  "cwd": "/home/dev/workspace/ClaudeCodeApp",
  "sessionId": "072cbcc6-99ae-4a67-9d50-ed3ab2d23e92",
  "version": "2.0.76",
  "gitBranch": "main",
  "message": {
    "role": "user",
    "content": [
      {"type": "text", "text": "What suggestions do you have?"}
    ]
  },
  "uuid": "52a0fd51-dfdb-4082-89d7-9c91bd353f9e",
  "timestamp": "2025-12-27T06:44:55.883Z"
}
```

### User Message (String Content)
```json
{
  "type": "user",
  "message": {
    "role": "user",
    "content": "Unknown slash command: model"
  },
  "uuid": "82962de4-6b1e-4ef4-9dde-73d099e9a4f8",
  "timestamp": "2025-12-27T06:17:30.331Z"
}
```

### Meta Message (System/Internal)
```json
{
  "type": "user",
  "isMeta": true,
  "message": {
    "role": "user",
    "content": "Caveat: The messages below were generated by the user while running local commands..."
  }
}
```

### Assistant Message
```json
{
  "type": "assistant",
  "parentUuid": "52a0fd51-dfdb-4082-89d7-9c91bd353f9e",
  "message": {
    "model": "claude-opus-4-5-20251101",
    "id": "msg_01Ez2cg2BaKqBuFbwuJak3HG",
    "type": "message",
    "role": "assistant",
    "content": [{"type": "text", "text": "Based on my review..."}],
    "stop_reason": null,
    "usage": {"input_tokens": 3, "output_tokens": 1}
  },
  "uuid": "305cd830-7e3e-45ef-acd9-be48bd2681ef",
  "timestamp": "2025-12-27T06:45:11.812Z"
}
```

### Queue Operation (Internal)
```json
{
  "type": "queue-operation",
  "operation": "dequeue",
  "timestamp": "2025-12-27T06:44:55.863Z",
  "sessionId": "072cbcc6-99ae-4a67-9d50-ed3ab2d23e92"
}
```

## iOS App Session Management

### Clean Architecture

The session system follows Clean Architecture principles:

```
Views -> SessionStore -> SessionRepository -> CLIBridgeAPIClient -> Backend
         (state)       (data layer)          (HTTP)
```

| Layer | Component | Purpose |
|-------|-----------|---------|
| State | `SessionStore` | Single source of truth, pagination, filtering |
| Data | `SessionRepository` | Protocol abstraction + API implementation |
| Network | `CLIBridgeAPIClient` | HTTP requests |
| View | `SessionPickerViews` | UI for session list |

### SessionStore (Singleton)

Access via `SessionStore.shared`. Manages all session state:

```swift
@Published var sessionsByProject: [String: [ProjectSession]]
@Published var metaByProject: [String: ProjectSessionMeta]
@Published var isLoading: [String: Bool]
@Published var activeSessionIds: [String: String]
```

**Key Methods:**
- `loadSessions(for:)` - Fetch from API
- `loadMore(for:)` - Pagination
- `deleteSession(_:for:)` - Optimistic delete with rollback
- `displaySessions(for:)` - Filtered/sorted for UI

### Session ID Sources

| Source | Where Used | Notes |
|--------|-----------|-------|
| `bridgeAdapter.sessionId` | Active session | Set on `result` SSE event |
| `SessionStore.shared` | All session state | Single source of truth |
| `activeSessionIds[path]` | Currently open session | Per-project tracking |

### Session Creation Flow

1. **User clicks "New"** -> Clears `bridgeAdapter.sessionId` and `selectedSession`
2. **User sends first message** -> Backend creates session -> `result` SSE event
3. **`onComplete` callback** -> Sets `bridgeAdapter.sessionId`, saves to `MessageStore`
4. **Session appears in picker** -> Added to `localSessions`, filter passes it through

### ClaudeHelper Sessions

ClaudeHelper (suggestions, file analysis) uses a deterministic session ID per project:

```swift
// ClaudeHelper.createHelperSessionId(for:)
// Generates consistent UUID from project path hash
// Example: /home/dev/workspace/ClaudeCodeApp -> always same UUID
```

This prevents session pollution (previously created new session for every helper call).

### Session Filtering

Sessions are filtered for display to exclude:
- Helper sessions (matched by `ClaudeHelper.createHelperSessionId`)
- Empty sessions (`messageCount < 1`)
- Agent sessions (filtered at shell level by `grep -v '^agent-'`)

```swift
// Models.swift - filterForDisplay()
extension Array where Element == ProjectSession {
    func filterForDisplay(projectPath: String, activeSessionId: String? = nil) -> [ProjectSession]
}
```

### Session Persistence

| Store | Key | Purpose |
|-------|-----|---------|
| UserDefaults | `sessionId_{encoded-path}` | Last active session per project |
| MessageStore | `{encoded-path}.json` | Chat history (50 messages) |

## SSH Commands for Sessions

> **Note**: When running these commands from Swift via SSH, use `$HOME` instead of `~` and double quotes. See `.claude/rules/ssh-security.md`.

### Count Sessions
```bash
cd $HOME/.claude/projects/-home-dev-workspace-ClaudeCodeApp && \
ls -1 *.jsonl 2>/dev/null | grep -v '^agent-' | while read f; do
    [ -s "$f" ] && echo "$f"
done | wc -l
```

### List Sessions with Metadata
```bash
cd $HOME/.claude/projects/-home-dev-workspace-ClaudeCodeApp && \
ls -1 *.jsonl 2>/dev/null | grep -v '^agent-' | while read f; do
    name=$(basename "$f" .jsonl)
    lines=$(wc -l < "$f" | tr -d ' ')
    mtime=$(stat -c %Y "$f" 2>/dev/null || stat -f %m "$f" 2>/dev/null)
    echo "$name|$lines|$mtime"
done
```

### Extract First User Message (Summary)
```bash
# Uses jq to handle both content formats (array and string)
grep '"type":"user"' session.jsonl | \
jq -r 'select(.isMeta != true) |
    (if .message.content | type == "array" then .message.content[0].text
     elif .message.content | type == "string" then .message.content
     else empty end) // empty' | \
grep -v '^Based on this conversation' | \
head -1 | head -c 80
```

## Key Files

| File | Purpose |
|------|---------|
| `SessionStore.swift` | Centralized state management, pagination, filtering |
| `SessionRepository.swift` | Protocol + API implementation + Mock |
| `CLIBridgeAdapter.swift` | Session creation via SSE `result` event |
| `CLIBridgeAPIClient.swift` | HTTP requests for session API |
| `ChatView.swift` | Session selection UI |
| `SSHManager.swift` | Session message loading (JSONL parsing) |
| `Models.swift` | `ProjectSession`, `ProjectSessionMeta` |
| `SessionPickerViews.swift` | Session picker UI |
| `ContentView.swift` | Project list with session counts |
| `MessageStore.swift` | Local message persistence |
| `ClaudeHelper.swift` | Helper session ID generation |

## Common Issues

### Sessions Not Appearing in Picker
1. Check `SessionStore.shared.sessionsByProject` has data
2. Verify `displaySessions(for:)` isn't filtering too aggressively
3. Ensure SSE `result` events are being handled
4. Check `activeSessionIds[path]` is passed to filter

### Session List Not Updating
1. Verify CLI Bridge is connected and receiving SSE events
2. Check `SessionStore` methods are being called
3. Look for errors in debug logs

### Wrong Session Counts
1. Check `SessionStore.metaByProject[path]?.total`
2. Verify API is returning correct pagination data

### ClaudeHelper Creating Many Sessions
1. Ensure `createHelperSessionId()` returns valid UUID format
2. Verify helper session ID is consistent for same project path

### Session Titles Missing
1. Check `jq` is installed on server (for SSH fallback)
2. Verify API is returning `summary` field
3. Ensure ClaudeHelper prompts are filtered

## Testing Sessions

```bash
# SSH to server
ssh claude-dev

# Navigate to project sessions (use $HOME when called from Swift)
cd $HOME/.claude/projects/-home-dev-workspace-ClaudeCodeApp

# Count all sessions
ls -1 *.jsonl | wc -l

# Count user sessions (exclude agents)
ls -1 *.jsonl | grep -v '^agent-' | wc -l

# View a session
cat {session-id}.jsonl | jq .

# Find user messages
grep '"type":"user"' {session-id}.jsonl | jq .message.content
```
